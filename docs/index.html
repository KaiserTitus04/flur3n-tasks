<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FLUR 3N – Weekly Tasks</title>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css">

<style>
body{font-family:system-ui,Arial,sans-serif;margin:1.6rem}
h1{text-align:center;margin-bottom:1.2rem}

.table-wrap{overflow-x:auto;border:1px solid #666;border-radius:4px}
table{border-collapse:collapse;border:1px solid #666;min-width:900px}
th,td{border:1px solid #666;padding:.4rem .5rem}
th{background:#f5f5f5;font-weight:600;text-align:center;position:sticky;top:0}
td.task{width:320px;text-align:left;white-space:pre-wrap}
td.person{width:55px;text-align:center}
.tick {color:#0a0;font-size:1.1rem}
.cross{color:#a00;font-size:1.1rem}
.empty{color:#ccc}
</style>
</head>

<body>
<h1>FLUR 3N – Weekly Tasks</h1>

<div class="table-wrap">
  <table id="tasks"><tbody><tr><td>Lade Daten …</td></tr></tbody></table>
</div>

<p style="text-align:right">
  <a href="WeeklyPlans/Tasks_latest.xlsx" download>Download Excel</a>
</p>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>

<script>
(async ()=>{
  const tbl = document.getElementById('tasks');

  // Excel holen
  let buf;
  try {
    const r = await fetch('WeeklyPlans/Tasks_latest.xlsx');
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    buf = await r.arrayBuffer();
  } catch(err) {
    tbl.innerHTML = `<tbody><tr><td style="color:#a00;">Download fehlgeschlagen: ${err}</td></tr></tbody>`;
    return;
  }

  // Workbook -> Array
  let rows = [];
  try{
    const wb  = XLSX.read(buf,{type:'array'});
    const ws  = wb.Sheets[wb.SheetNames[0]];
    rows = XLSX.utils.sheet_to_json(ws,{header:1,range:3});
  }catch(err){
    tbl.innerHTML = `<tbody><tr><td style="color:#a00;">Parsen fehlgeschlagen: ${err}</td></tr></tbody>`;
    return;
  }

  if(rows.length===0){
    tbl.innerHTML = `<tbody><tr><td>Keine Daten im Sheet.</td></tr></tbody>`;
    return;
  }

  // Header + Kürzen leerer Spalten
  const head = rows.shift();
  const lastCol = head.reduce((acc,v,i)=> v!==undefined ? i : acc, 0);
  head.length = lastCol+1;
  rows = rows.map(r=>{ while(r.length<lastCol+1) r.push(undefined); return r; });

  // Bis erste komplett leere Zeile
  const cut = rows.findIndex(r=>r.every(c=>c===undefined));
  if(cut!==-1) rows = rows.slice(0,cut);

  // Tabelle bauen
  const thead = '<thead><tr>'+head.map((c,i)=>`<th>${i?c||'':"Task / Description"}</th>`).join('')+'</tr></thead>';
  const tbody = '<tbody>'+rows.map(r=>{
    return '<tr>'+r.map((c,i)=>{
      if(i===0) return `<td class="task">${c||''}</td>`;
      if(c==='✓') return '<td class="tick">✓</td>';
      if((c||'').toString().toUpperCase()==='X') return '<td class="cross">❌</td>';
      return '<td class="person"></td>';
    }).join('')+'</tr>';
  }).join('')+'</tbody>';

  tbl.innerHTML = thead+tbody;

  // DataTable nur wenn Kopf+Körper vorhanden
  new simpleDatatables.DataTable(tbl,{searchable:false,paging:false,fixedHeight:true});
})();
</script>
</body>
</html>
